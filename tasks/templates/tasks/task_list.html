{% extends 'base.html' %}
{% load static %}

{% block title %}Your Todo List{% endblock %}
{% block body_title %}Your Todo List{% endblock %}

{% block content %}

<form x-data="taskCreateForm()"
      class="mt-4 mx-auto is-flex is-justify-content-center"
      @submit.prevent="taskCreate">
  <input type="text"
         id="task-create-input-description"
         class="input is-inline is-medium btn-group-left-side"
         placeholder="Enter new task...">
  <input type="submit"
         id="task-create-button-confirm"
         class="button is-info is-medium btn-group-right-side"
         value="Create">
</form>

<script>
  function taskCreateForm() {
    return {
      // methods
      userIsAuthenticated() {
        return {{ user.is_authenticated|yesno:'true,false' }};
      },
      taskCreate() {
        if (!this.userIsAuthenticated()) {
          // do not continue if user is not authenticated
          hDispatch(
            'status-message-display',
            "You must login before you can add any tasks.");
          return false;
        }
        else {
          // get the value of the text input, then clear it
          let textInput = document
            .querySelector("#task-create-input-description");
          let description = textInput.value;
          textInput.value = '';

          // issue a POST request using HTMX
          htmx.ajax('POST', '{% url 'tasks:task_create' %}', {
            target: '#tasks',
            values: { description },
          });
        }
      }
    }
  }

  // CRUD functions
  function updateDivToggle(id) {
    let updateDiv = document.querySelector(`#update-div-${id}`);
    let descriptionDiv = document
      .querySelector(`#task-description-${id}`);
    updateDiv.classList.toggle('is-hidden');
    descriptionDiv.classList.toggle('is-hidden');

    if (!updateDiv.classList.contains('is-hidden')) {
      // select the text input when showing the div
      document.querySelector(`#task-update-description-${id}`).select();
    } else {
      // reset the text input when hiding the div
      document.querySelector(`#task-update-form-${id}`).reset();
    }

  }

  function updateConfirm(id) {
    let input = document.querySelector(`#task-update-description-${id}`);
    let updateDiv = document.querySelector(`#update-div-${id}`)
    let descriptionDiv = document
      .querySelector(`#task-description-${id}`);
    updateDiv.classList.add('is-hidden');
    descriptionDiv.classList.remove('is-hidden');
    let result = input.value;
    input.value = '';
    return result;
  }

  function taskDelete(id) {
    htmx.ajax('DELETE', `{% url 'tasks:task_delete_noid' %}${id}/`, {
      target: '#tasks'
    });
  }

</script>

{% include 'tasks/list_task.html' %}

{% endblock content %}
